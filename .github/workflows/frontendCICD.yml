# Tên của Workflow
name: Frontend - Staging tự động • Production cần duyệt

on:
  pull_request:
    # Kích hoạt test và staging khi có PR nhắm vào main
    branches: [ main ]
    paths:
      - 'foodHub-frontend-client/**'
      - '.github/workflows/frontendCICD.yml'
  workflow_dispatch:

jobs:
  # ===============================================
  # GIAI ĐOẠN 1: TEST VÀ BUILD (CI)
  # ===============================================
  build-test:
    name: 1. Test và Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: foodHub-frontend-client
    environment: test

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: foodHub-frontend-client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Tests (nếu có)
        run: npm run test --if-present || echo "Không có test, bỏ qua"

      - name: Build Frontend Build
        run: npm run build
        env:
          CI: false
          REACT_APP_GOONG_API_KEY: ${{ secrets.REACT_APP_GOONG_API_KEY }}
          REACT_APP_MAPBOX_API_KEY: ${{ secrets.REACT_APP_MAPBOX_API_KEY }}
          REACT_APP_STRIPE_PUBLIC_KEY: ${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY }}

          REACT_APP_GOONG_GEOCODE: ${{ vars.REACT_APP_GOONG_GEOCODE }}
          REACT_APP_GOONG_AUTOCOMPLETE: ${{ vars.REACT_APP_GOONG_AUTOCOMPLETE }}
          REACT_APP_GOONG_DISTANCEMATRIX: ${{ vars.REACT_APP_GOONG_DISTANCEMATRIX }}
          REACT_APP_MAPBOX_DIRECTION_URL: ${{ vars.REACT_APP_MAPBOX_DIRECTION_URL }}
          REACT_APP_MAPBOX_GEOCODING: ${{ vars.REACT_APP_MAPBOX_GEOCODING }}
          REACT_APP_AUTOCOMPLETE_LIMIT: ${{ vars.REACT_APP_AUTOCOMPLETE_LIMIT }}
          REACT_APP_CURRENCY: ${{ vars.REACT_APP_CURRENCY }}
          PING_TIMEOUT: ${{ vars.PING_TIMEOUT }}
          REACT_APP_SERVER_URL: ${{ vars.REACT_APP_SERVER_URL }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          # ⭐️ ĐẢM BẢO PATH ĐÚNG: Thay 'foodHub-frontend-client/dist' bằng thư mục build thực tế (thường là build hoặc dist)
          path: foodHub-frontend-client/build 

  build-push-docker-simple:
    needs: build-test
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build the Docker image
        run: |
          docker build ./foodHub-frontend-client \
            --file ./foodHub-frontend-client/Dockerfile \
            --tag ${{ secrets.DOCKER_USERNAME }}/foodhub-frontend:latest

      - name: Docker Push
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/foodhub-backend:latest

      - name: Docker Image Published
        run: |
          echo "✅ Đã push image backend thành công (tag: latest)"
  # =======================================================
  # GIAI ĐOẠN 2: TRIỂN KHAI STAGING (Tự động khi có PR hoặc chạy thủ công)
  # =======================================================
  deploy-staging:
    name: 2. Deploy Staging (Review/Demo)
    needs: [build-test,build-push-docker-simple]
    # ⭐️ CẬP NHẬT IF: Chạy nếu kết quả build-test thành công VÀ (có PR HOẶC chạy thủ công)
    if: ${{ always() && github.event_name != 'push' }} 
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build

      - name: Trigger Render Staging
        # Giả định Render service sẽ fetch và triển khai từ artifact
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_STAGING_HOOK }}

  # ==========================================================
  # GIAI ĐOẠN 3: TRIỂN KHAI PRODUCTION (Sau khi MERGE, cần Phê duyệt)
  # ==========================================================
  deploy-production:
    name: 3. Deploy Production (Cần Phê duyệt)
    needs: [build-test,build-push-docker-simple,deploy-staging] 
    # ⭐️ CẬP NHẬT IF: CHỈ CHẠY khi code được MERGE (push vào main) HOẶC chạy thủ công
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://foodhub.vn

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build

      - name: Trigger Render Production
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_PROD_HOOK }}

      - name: Production LIVE
        run: |
          echo "Frontend Production đã deploy thành công!"
          echo "Truy cập: https://foodhub.vn"


  create-issue-on-fail:
    needs: build-test
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      # Bước 1: Tạo issue bằng action cũ (dacbd) – output tên là "issue"
      - name: Tạo Issue khi test fail
        id: create_issue
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "TEST FAIL – Sửa gấp! (Commit: ${{ github.sha }})"
          body: |
            Test frontend fail khi merge vào main.
            Commit: ${{ github.sha }}
            Người push: @${{ github.actor }}
            Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # Bước 2: Assign bằng pozil – dùng đúng tên output là "issue" (không phải issue-number)
      - name: Assign issue cho người gây lỗi
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = "${{ steps.create_issue.outputs.issue || steps.create_issue.outputs.number }}";
            if (issueNum) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                assignees: ["${{ github.actor }}"]
              });
              console.log(`Đã assign issue #${issueNum} cho @${{ github.actor }}`);
            }