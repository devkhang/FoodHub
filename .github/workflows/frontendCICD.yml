name: Frontend - Staging tự động • Production cần duyệt

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'foodHub-frontend-client/**'
      - '.github/workflows/frontendCICD.yml'
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: foodHub-frontend-client
    environment: test

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: foodHub-frontend-client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Tests (nếu có)
        run: npm run test --if-present || echo "Không có test, bỏ qua"

      - name: Build Frontend Build
        run: npm run build
        env:
          REACT_APP_GOONG_API_KEY: ${{ secrets.REACT_APP_GOONG_API_KEY }}
          REACT_APP_MAPBOX_API_KEY: ${{ secrets.REACT_APP_MAPBOX_API_KEY }}
          REACT_APP_STRIPE_PUBLIC_KEY: ${{ secrets.REACT_APP_STRIPE_PUBLIC_KEY }}

          REACT_APP_GOONG_GEOCODE: ${{ vars.REACT_APP_GOONG_GEOCODE }}
          REACT_APP_GOONG_AUTOCOMPLETE: ${{ vars.REACT_APP_GOONG_AUTOCOMPLETE }}
          REACT_APP_GOONG_DISTANCEMATRIX: ${{ vars.REACT_APP_GOONG_DISTANCEMATRIX }}
          REACT_APP_MAPBOX_DIRECTION_URL: ${{ vars.REACT_APP_MAPBOX_DIRECTION_URL }}
          REACT_APP_MAPBOX_GEOCODING: ${{ vars.REACT_APP_MAPBOX_GEOCODING }}
          REACT_APP_AUTOCOMPLETE_LIMIT: ${{ vars.REACT_APP_AUTOCOMPLETE_LIMIT }}
          REACT_APP_CURRENCY: ${{ vars.REACT_APP_CURRENCY }}
          PING_TIMEOUT: ${{ vars.PING_TIMEOUT }}
          REACT_APP_SERVER_URL: ${{ vars.REACT_APP_SERVER_URL }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: foodHub-frontend-client/dist

  deploy-staging:
    needs: build-test
    if: ${{ needs.build-test.result == 'success' }}
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: Trigger Render Staging
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_STAGING_HOOK }}

  deploy-production:
    needs: [build-test, deploy-staging]
    if: ${{ needs.build-test.result == 'success' && needs.deploy-staging.result == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://foodhub.vn

    steps:                                    # ← Chỉ để 1 lần steps duy nhất!
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: Trigger Render Production
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_PROD_HOOK }}

      - name: Production LIVE
        run: |
          echo "Frontend Production đã deploy thành công!"
          echo "Truy cập: https://foodhub.vn"