name: CI/CD - Staging t·ª± ƒë·ªông ‚Ä¢ Production c·∫ßn duy·ªát

on:
  pull_request:
    branches: [main]
    paths:
      - 'foodHub-backend-server/**'          # Ch·ªâ ch·∫°y khi thay ƒë·ªïi trong th∆∞ m·ª•c backend
      - '.github/workflows/backendCICD.yml'

jobs:
  # ==================== 1. UNIT TEST ====================
  test:
    runs-on: ubuntu-latest
    environment: test
    defaults:
      run:
        working-directory: foodHub-backend-server

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: foodHub-backend-server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: npm run test
        env: 
          NODE_ENV: ${{ vars.NODE_ENV }}
          PORT: ${{ vars.PORT }}
          PING_TIMEOUT: ${{ vars.PING_TIMEOUT }}
          PINT_INTERVAL: ${{ vars.PINT_INTERVAL }}
          DELIVERY_CHARGE_BASE: ${{ vars.DELIVERY_CHARGE_BASE }}
          DELIVERY_CHARGE_RATE_PER_KM: ${{ vars.DELIVERY_CHARGE_RATE_PER_KM }}
          DELIVERY_JOB_ACCEPT_TIMEOUT: ${{ vars.DELIVERY_JOB_ACCEPT_TIMEOUT }}
          DISTANCE_ACCEPTED_RANGE: ${{ vars.DISTANCE_ACCEPTED_RANGE }}
          MAX_DISTANCE_ACCEPTED_RANGE: ${{ vars.MAX_DISTANCE_ACCEPTED_RANGE }}
          MAX_ASSIGNMENT_ATTEMP: ${{ vars.MAX_ASSIGNMENT_ATTEMP }}
          MAX_ITEM_PER_PAGE: ${{ vars.MAX_ITEM_PER_PAGE }}
          MAX_RESTAURANT_ACCEPT_RANGE: ${{ vars.MAX_RESTAURANT_ACCEPT_RANGE }}
          NETWORK_DELAY: ${{ vars.NETWORK_DELAY }}
          NO_SUITABLE_DRONE_RETRY: ${{ vars.NO_SUITABLE_DRONE_RETRY }}
          FRONT_END_URL: ${{ vars.FRONT_END_URL }}
          # L∆∞u √Ω: Ki·ªÉm tra k·ªπ t√™n Secret b√™n d∆∞·ªõi (MONGODB hay MONGODH)
          MONGODH_URL: ${{ secrets.MONGODH_URL }} 
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

  automated-api-tests:
    runs-on: ubuntu-latest
    environment: test
    needs: test
    if: ${{ needs.test.result == 'success' }}
    defaults:
      run:
        working-directory: foodHub-backend-server # üëà Quan tr·ªçng: tr·ªè ƒë√∫ng th∆∞ m·ª•c code

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: foodHub-backend-server/package-lock.json

      - name: Install dependencies
        run: npm ci

      # ‚≠êÔ∏è B∆Ø·ªöC M·ªöI: C√†i wait-on ƒë·ªÉ ch·ªù server kh·ªüi ƒë·ªông xong
      - name: Install wait-on
        run: npm install -g wait-on

      # ‚≠êÔ∏è B∆Ø·ªöC QUAN TR·ªåNG NH·∫§T: B·∫≠t Server ch·∫°y n·ªÅn (&)
      - name: Start Server & Wait
        run: |
          npm start & 
          npx wait-on http://localhost:${{ vars.PORT }} # Ch·ªù ƒë·∫øn khi port m·ªü th√¨ m·ªõi ch·∫°y b∆∞·ªõc ti·∫øp
        env:
          # Ph·∫£i copy to√†n b·ªô bi·∫øn m√¥i tr∆∞·ªùng xu·ªëng ƒë√¢y ƒë·ªÉ Server ch·∫°y ƒë∆∞·ª£c
          NODE_ENV: ${{ vars.NODE_ENV }}
          PORT: ${{ vars.PORT }}
          PING_TIMEOUT: ${{ vars.PING_TIMEOUT }}
          PINT_INTERVAL: ${{ vars.PINT_INTERVAL }}
          DELIVERY_CHARGE_BASE: ${{ vars.DELIVERY_CHARGE_BASE }}
          DELIVERY_CHARGE_RATE_PER_KM: ${{ vars.DELIVERY_CHARGE_RATE_PER_KM }}
          DELIVERY_JOB_ACCEPT_TIMEOUT: ${{ vars.DELIVERY_JOB_ACCEPT_TIMEOUT }}
          DISTANCE_ACCEPTED_RANGE: ${{ vars.DISTANCE_ACCEPTED_RANGE }}
          MAX_DISTANCE_ACCEPTED_RANGE: ${{ vars.MAX_DISTANCE_ACCEPTED_RANGE }}
          MAX_ASSIGNMENT_ATTEMP: ${{ vars.MAX_ASSIGNMENT_ATTEMP }}
          MAX_ITEM_PER_PAGE: ${{ vars.MAX_ITEM_PER_PAGE }}
          MAX_RESTAURANT_ACCEPT_RANGE: ${{ vars.MAX_RESTAURANT_ACCEPT_RANGE }}
          NETWORK_DELAY: ${{ vars.NETWORK_DELAY }}
          NO_SUITABLE_DRONE_RETRY: ${{ vars.NO_SUITABLE_DRONE_RETRY }}
          FRONT_END_URL: ${{ vars.FRONT_END_URL }}
          MONGODH_URL: ${{ secrets.MONGODH_URL }} 
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
          
      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
        
      - name: Run API tests
        # Th√™m --reporters cli ƒë·ªÉ xem log chi ti·∫øt
        run: |
          postman collection run "36233358-b41bdabb-c961-4c77-9183-ff60f4b8f90d" -e "36233358-c98de25f-e0f1-45c4-8071-c8792952b0ab"

  # ==================== 3. BUILD & PUSH DOCKER IMAGE ====================
  build-push-docker-simple:
    needs: test
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build the Docker image
        run: |
          docker build ./foodHub-backend-server \
            --file ./foodHub-backend-server/Dockerfile \
            --tag ${{ secrets.DOCKER_USERNAME }}/foodhub-backend:latest

      - name: Docker Push
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/foodhub-backend:latest

      - name: Docker Image Published
        run: echo "‚úÖ ƒê√£ push image backend th√†nh c√¥ng (latest)"

  # ==================== 4. STAGING DEPLOY ====================
  deploy-staging:
    needs: [test, build-push-docker-simple] # C√≥ th·ªÉ th√™m automated-api-tests v√†o ƒë√¢y n·∫øu mu·ªën test xong m·ªõi deploy
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Ki·ªÉm tra bi·∫øn secrets (Debug)
        run : echo "RENDER_STAGING_DEPLOY_HOOK exist check..." # Kh√¥ng n√™n echo tr·ª±c ti·∫øp secret ra log
      
      - name: Deploy to Staging
        run: curl -X POST ${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_URL }}

      - name: Staging Live
        run: echo "Staging ƒë√£ l√™n s√≥ng ‚Üí https://foodhub-3.onrender.com"

  # ==================== 5. PRODUCTION DEPLOY ====================
  deploy-production:
    needs: [test, build-push-docker-simple, deploy-staging]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://foodhub-6342.onrender.com

    steps:
      - name: Deploy to Production
        run: curl -X POST ${{ secrets.RENDER_PROD_DEPLOY_HOOK }}

      - name: Production Live
        run: echo "PRODUCTION ƒê√É L√äN S√ìNG TH√ÄNH C√îNG!"

  # ==================== 6. ERROR HANDLING (ISSUE) ====================
  create-issue-on-fail:
    needs: test
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: T·∫°o Issue khi test fail
        id: create_issue
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "TEST FAIL ‚Äì S·ª≠a g·∫•p! (Commit: ${{ github.sha }})"
          body: |
            Test backend fail sau khi merge v√†o main.
            Commit: ${{ github.sha }}
            Ng∆∞·ªùi push: @${{ github.actor }}
            Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Assign issue cho ng∆∞·ªùi g√¢y l·ªói
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = "${{ steps.create_issue.outputs.issue || steps.create_issue.outputs.number }}";
            if (issueNum) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                assignees: ["${{ github.actor }}"]
              });
              console.log(`ƒê√£ assign issue #${issueNum} cho @${{ github.actor }}`);
            } else {
              console.log("Kh√¥ng t√¨m th·∫•y s·ªë issue ƒë·ªÉ assign.");
            }